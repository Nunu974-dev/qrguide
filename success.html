<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commande confirm√©e - QRGUIDE.FR</title>
    <link rel="icon" type="image/jpeg" href="img/logo_icone.jpg">
    <link rel="stylesheet" href="style.css?v=2">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        .success-container {
            min-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 60px 20px;
        }
        .success-box {
            max-width: 600px;
            background: white;
            padding: 60px 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .success-icon {
            font-size: 80px;
            margin-bottom: 24px;
        }
        .success-box h1 {
            color: var(--primary-color);
            margin-bottom: 16px;
        }
        .success-box p {
            font-size: 1.1rem;
            line-height: 1.7;
            color: var(--text-gray);
            margin-bottom: 16px;
        }
        .success-steps {
            text-align: left;
            background: var(--bg-light);
            padding: 24px;
            border-radius: 12px;
            margin: 32px 0;
        }
        .success-steps h3 {
            margin-bottom: 16px;
            color: var(--text-dark);
        }
        .success-steps ol {
            padding-left: 20px;
        }
        .success-steps li {
            margin-bottom: 12px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="nav">
                <a href="index.html"><img src="img/logo.png" alt="QRGUIDE.FR" class="logo"></a>
                <div class="nav-links">
                    <a href="index.html#fonctionnalites">Fonctionnalit√©s</a>
                    <a href="index.html#comment-ca-marche">Comment √ßa marche</a>
                    <a href="tarifs.html">Tarifs</a>
                    <a href="hotels.html">H√¥tels</a>
                    <a href="contact.html">Contact</a>
                    <a href="abonnement.html" class="btn-primary">S'abonner</a>
                </div>
            </nav>
        </div>
    </header>

    <div class="success-container">
        <div class="success-box">
            <div class="success-icon">üéâ</div>
            <h1>Paiement r√©ussi !</h1>
            <p>Merci pour votre confiance. Votre commande a √©t√© confirm√©e.</p>
            <p><strong>Un email de confirmation vous a √©t√© envoy√©.</strong></p>

            <div class="success-steps">
                <h3>Prochaines √©tapes :</h3>
                <ol>
                    <li>üìß V√©rifiez votre bo√Æte mail (et vos spams)</li>
                    <li>üìù Remplissez le formulaire d'informations que nous vous enverrons</li>
                    <li>‚è±Ô∏è Nous cr√©ons votre guide sous 48h</li>
                    <li>‚úÖ Vous recevez votre guide et le QR code</li>
                </ol>
            </div>

            <p style="margin-top: 32px;">
                <strong>Besoin d'aide ?</strong><br>
                Contactez-nous : <a href="mailto:contact@qrguide.fr" style="color: var(--primary-color);">contact@qrguide.fr</a> 
                ou <a href="tel:0692630364" style="color: var(--primary-color);">06 92 63 03 64</a>
            </p>

            <a href="index.html" class="btn-hero" style="margin-top: 32px; display: inline-block;">Retour √† l'accueil</a>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <img src="img/logo_blanc.png" alt="QRGUIDE.FR" class="footer-logo">
                    <p>Le guide num√©rique nouvelle g√©n√©ration pour locations saisonni√®res et h√¥tels</p>
                </div>
                <div class="footer-col">
                    <h4>Produit</h4>
                    <a href="index.html#fonctionnalites">Fonctionnalit√©s</a>
                    <a href="index.html#comment-ca-marche">Comment √ßa marche</a>
                    <a href="tarifs.html">Tarifs</a>
                    <a href="demo-guide/index.html" target="_blank">Voir la d√©mo</a>
                </div>
                <div class="footer-col">
                    <h4>Support</h4>
                    <a href="contact.html">Contact</a>
                    <a href="mailto:contact@qrguide.fr">contact@qrguide.fr</a>
                    <a href="tel:0692630364">06 92 63 03 64</a>
                </div>
                <div class="footer-col">
                    <h4>L√©gal</h4>
                    <a href="mentions-legales.html">Mentions l√©gales</a>
                    <a href="cgv.html">CGV</a>
                    <a href="politique-confidentialite.html">Confidentialit√©</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 QRGUIDE.FR - Tous droits r√©serv√©s</p>
            </div>
        </div>
    </footer>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        // Fonction pour g√©n√©rer un mot de passe al√©atoire s√©curis√©
        function generatePassword() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789@#$%';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // Cr√©er le compte Firebase et envoyer l'email de confirmation
        async function setupUserAccount() {
            // R√©cup√©rer les infos du localStorage
            const orderData = localStorage.getItem('qrguide_order');
            
            if (!orderData) {
                console.log('Aucune donn√©e de commande trouv√©e');
                return;
            }
            
            try {
                const data = JSON.parse(orderData);
                const generatedPassword = generatePassword();
                
                console.log('üìß Cr√©ation du compte pour:', data.email);
                
                // 1. Cr√©er le compte Firebase
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(
                    data.email,
                    generatedPassword
                );
                
                const user = userCredential.user;
                console.log('‚úÖ Compte Firebase cr√©√©:', user.uid);
                
                // 2. Ajouter les informations utilisateur dans Firestore
                await firebase.firestore().collection('users').doc(user.uid).set({
                    email: data.email,
                    firstname: data.firstname,
                    lastname: data.lastname,
                    displayName: `${data.firstname} ${data.lastname}`,
                    phone: data.phone,
                    postalCode: data.postalCode,
                    role: 'client',
                    plan: data.planType,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active'
                });
                
                console.log('‚úÖ Donn√©es Firestore enregistr√©es');
                
                // 3. Envoyer l'email avec les identifiants
                const response = await fetch('send-confirmation-email.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: data.email,
                        name: `${data.firstname} ${data.lastname}`,
                        amount: data.amount / 100,
                        planType: data.planType,
                        plaqueQty: data.plaqueQty || 0,
                        password: generatedPassword
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ Email de confirmation envoy√© avec identifiants');
                    // D√©connecter l'utilisateur (il devra se reconnecter avec ses identifiants)
                    await firebase.auth().signOut();
                    // Supprimer les donn√©es
                    localStorage.removeItem('qrguide_order');
                } else {
                    console.error('‚ùå Erreur envoi email:', result.error);
                }
                
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                // Si le compte existe d√©j√†, envoyer quand m√™me l'email
                if (error.code === 'auth/email-already-in-use') {
                    console.log('‚ö†Ô∏è Compte existant, envoi email sans mot de passe');
                    try {
                        const data = JSON.parse(orderData);
                        await fetch('send-confirmation-email.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                email: data.email,
                                name: `${data.firstname} ${data.lastname}`,
                                amount: data.amount / 100,
                                planType: data.planType,
                                existingAccount: true
                            })
                        });
                        localStorage.removeItem('qrguide_order');
                    } catch (e) {
                        console.error('Erreur envoi email:', e);
                    }
                }
            }
        }
        
        // Ex√©cuter APR√àS que Firebase soit charg√©
        window.addEventListener('load', async () => {
            // Attendre que Firebase soit initialis√©
            await new Promise(resolve => setTimeout(resolve, 1000));
            console.log('üî• Firebase pr√™t, cr√©ation du compte...');
            setupUserAccount();
        });
    </script>
</body>
</html>
